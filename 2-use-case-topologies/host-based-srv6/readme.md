## Host Based SRv6 with Cilium

### preparation, kubeadm init
1. Install containerd and kubeadm/kubelet/kubectl on one or more hosts/VMs
https://github.com/segmentrouting/srv6-labs/blob/main/2-use-case-topologies/host-based-srv6/k8s-install.md

2. enable ipv4 and ipv6 forwarding in /etc/sysctl.conf
3. kubeadm init on control plane node:
```
kubeadm init --pod-network-cidr=10.244.0.0/16,bb:44:0::/64 --service-cidr=10.96.0.0/16,fc00:0:9944::/112
```
or
```
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
networking:
  podSubnet: 10.244.0.0/16,2001:db8:42:0::/56
  serviceSubnet: 10.96.0.0/16,2001:db8:42:1::/112
---
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: "10.42.1.2"
  bindPort: 6443
nodeRegistration:
  kubeletExtraArgs:
    node-ip: 10.42.1.2,fc00:0:42:1::2
```
```
kubeadm init --config=kubeadm-config.yaml
```

4. verify nodes:
```
kubectl get nodes -o wide
kubectl get node -o yaml
kubectl describe nodes | grep -E 'InternalIP'
kubectl get nodes -o jsonpath='{.items[*].spec.podCIDR}'
kubectl cluster-info dump | grep -m 1 cluster-cidr
ps -ef | grep "cluster-cidr"
```
### install Helm then Cilium
1. Install Helm: https://helm.sh/docs/intro/install/
2. Add helm cilium repo:
```
helm repo add isovalent https://helm.isovalent.com
```

1. Base helm chart
https://github.com/segmentrouting/srv6-labs/blob/main/2-use-case-topologies/host-based-srv6/cilium/linux-node00/helm-install.yaml

```
helm install cilium isovalent/cilium --version 1.15.6  --namespace kube-system -f helm-cilium-ent.yaml 
```

#### helm upgrade (if making changes)
```
helm upgrade -f helm-install.yaml cilium isovalent/cilium -n kube-system
```

#### optional: restart cilium operator:
```
kubectl -n kube-system rollout restart ds/cilium
```

2. verify cilium, helm get values, show node labels
```
kubectl get ds -n kube-system cilium
helm get values cilium -n kube-system
kubectl get nodes --show-labels=true
```

###  cilium bgp peering with SRv6 L3VPN

1. bgp yaml
```
apiVersion: "cilium.io/v2alpha1"
kind: CiliumBGPPeeringPolicy
metadata:
  name: control-plane
spec:
  nodeSelector:
    matchLabels:
      kubernetes.io/hostname: cluster00-cp
  virtualRouters:
  - localASN: 65044
    exportPodCIDR: true
    mapSRv6VRFs: true
    neighbors:
    - peerAddress: "10.44.1.1/32"
      peerASN: 65040
      families:
       - afi: ipv4
         safi: unicast
    - peerAddress: "2001:db8:18:44::1/128"
      peerASN: 65040
      families:
        - afi: ipv6
          safi: unicast
        - afi: ipv4
          safi: mpls_vpn
```

2. apply cilium bgp
```
kubectl apply -f bgp-policy.yaml
```

3. verify bgp peering
```
cilium bgp peers
```

4. manually add bgp router-id if needed:
```
kubectl annotate node cluster00-cp cilium.io/bgp-virtual-router.65044="router-id=10.44.1.2"
```

5. may need ToR to peer with host's autogenerated IPv6 address
```
 neighbor 2001:db8:18:44:5054:60ff:fe01:a008
  remote-as 65044
  use neighbor-group ebgp-v6
```
### SRv6 sidmanager and locators

1. Define locator pool
```
apiVersion: isovalent.com/v1alpha1
kind: IsovalentSRv6LocatorPool
metadata:
  name: pool0
spec:
  behaviorType: uSID
  prefix: fc00:0:99::/48
  locatorLenBits: 64
  structure:
    locatorBlockLenBits: 32
    locatorNodeLenBits: 16
    functionLenBits: 32
    argumentLenBits: 0
```

2. validate locator pool
```
kubectl get sidmanager -o yaml
or 
kubectl get sidmanager -o custom-columns="NAME:.metadata.name,ALLOCATIONS:.spec.locatorAllocations"
```
```
apiVersion: v1
items:
- apiVersion: isovalent.com/v1alpha1
  kind: IsovalentSRv6SIDManager
  metadata:
    creationTimestamp: "2024-07-18T02:37:01Z"
    generation: 1
    name: cluster00-cp
    resourceVersion: "28245"
    uid: 36ad059f-3163-4953-a3ee-35b09d4b1ddb
  spec:
    locatorAllocations:
    - locators:
      - behaviorType: uSID
        prefix: fc00:0:99:f94d::/64
        structure:
          argumentLenBits: 0
          functionLenBits: 32
          locatorBlockLenBits: 32
          locatorNodeLenBits: 16
      poolRef: pool0
  status:
    sidAllocations: []
- apiVersion: isovalent.com/v1alpha1
  kind: IsovalentSRv6SIDManager
  metadata:
    creationTimestamp: "2024-07-18T02:37:01Z"
    generation: 1
    name: cluster00-wkr00
    resourceVersion: "28244"
    uid: 970b43d3-d2e5-4a41-a80d-dc029856c1b4
  spec:
    locatorAllocations:
    - locators:
      - behaviorType: uSID
        prefix: fc00:0:99:d2a1::/64
        structure:
          argumentLenBits: 0
          functionLenBits: 32
          locatorBlockLenBits: 32
          locatorNodeLenBits: 16
      poolRef: pool0
  status:
    sidAllocations: []
kind: List
metadata:
  resourceVersion: ""
```
### VRFs
1. add vrf
```
apiVersion: isovalent.com/v1alpha1
kind: IsovalentVRF
metadata:
  name: blue
spec:
  vrfID: 1
  importRouteTarget: "12:12"
  exportRouteTarget: "12:12"
  locatorPoolRef: pool0
  rules:
  - selectors:
    - endpointSelector:
        matchLabels:
          vrf: blue
    destinationCIDRs:
    - 0.0.0.0/0
```

2. verify VRF and sid allocation:
```
kubectl get sidmanager cluster00-cp -o yaml
```
```
apiVersion: isovalent.com/v1alpha1
kind: IsovalentSRv6SIDManager
metadata:
  creationTimestamp: "2024-07-18T02:37:01Z"
  generation: 1
  name: cluster00-cp
  resourceVersion: "29119"
  uid: 36ad059f-3163-4953-a3ee-35b09d4b1ddb
<snip>
status:
  sidAllocations:
  - poolRef: pool0
    sids:
    - behavior: uDT4            <-----------------
      behaviorType: uSID
      metadata: blue
      owner: srv6-manager
      sid:
        addr: 'fc00:0:99:f94d:74c4::'
        structure:
          argumentLenBits: 0
          functionLenBits: 32
          locatorBlockLenBits: 32
          locatorNodeLenBits: 16
```

3. deploy a pod:
```
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: nginx-test
    vrf: blue
  name: nginx-test
spec:
  containers:
  - image: nginx:latest
    name: nginx-test
```

4.  get pods/describe pod, exec into pod
```
kubectl get pods -A
kubectl get pod blue -o=jsonpath="{.status.podIPs}"
kubectl describe pod nginx-test
kubectl exec -it nginx-test -- bash
```
```
kubectl get pod nginx-test -o=jsonpath="{.status.podIPs}"
```
example outpue:
```
[{"ip":"10.142.1.25"},{"ip":"2001:db8:142:1::f0cb"}]
```


### Cilium SRv6 responder
```
kubectl annotate --overwrite nodes cluster00-cp cilium.io/bgp-virtual-router.65044="router-id=10.44.1.2,srv6-responder=true"
```

### handy commands
```
cilium bgp routes advertised ipv4 mpls_vpn 
cilium bgp routes available ipv4 mpls_vpn
cilium bgp routes available ipv4 unicast
cilium bgp routes available ipv6 unicast
kubectl get IsovalentSRv6EgressPolicy
kubectl get IsovalentSRv6EgressPolicy -o yaml
kubectl get IsovalentSRv6EgressPolicy /bgp-control-plane-16bbd4214d4e691ddf412a6a078265de02d8cff5a3c4aa618712e8a1444477a9 -o yaml
kubectl get configmap -n kube-system cilium-config -o yaml
kubectl get isovalentvrf -o yaml
kubectl exec -n kube-system cilium-6z5gs -- cilium-dbg bpf srv6 sid
kubectl exec -n kube-system cilium-6z5gs -- cilium-dbg bpf srv6 vrf
kubectl exec -n kube-system cilium-6z5gs -- cilium-dbg bpf srv6 policy
```

### very quick:
```
sudo kubeadm init --pod-network-cidr=10.200.0.0/16,2001:db8:200:0::/56 --service-cidr=10.96.0.0/20,2001:db8:44:44:44:44::/112
helm install cilium isovalent/cilium --version 1.15.6  --namespace kube-system -f helm-cilium-ent.yaml
helm get values cilium -n kube-system
kubectl taint nodes --all node-role.kubernetes.io/control-plane-
kubectl apply -f bgp-cp.yaml 
kubectl apply -f bgp-wkr.yaml
cilium bgp peers
kubectl apply -f locator-pool.yaml 
kubectl get sidmanager -o yaml
kubectl apply -f vrf-blue.yaml 
kubectl create namespace blue
kubectl apply -f nginx-blue.yaml 

kubectl exec -it -n kube-system cilium-22mvq -- cilium-dbg bpf srv6 policy
kubectl exec -it -n kube-system cilium-22mvq -- cilium-dbg bpf srv6 sid
kubectl exec -it -n kube-system cilium-22mvq -- cilium-dbg bpf srv6 vrf
cilium bgp routes advertised ipv4 mpls_vpn

kubectl annotate --overwrite nodes cluster00-cp cilium.io/bgp-virtual-router.65044="router-id=10.44.1.2,srv6-responder=true"
kubectl get IsovalentSRv6EgressPolicy -o yaml
```


### appendix

1.  helm uninstall
```
helm uninstall cilium isovalent/cilium -n kube-system
```

1.  helm list
```
cisco@j-cluster00-node00:~/helm$ helm list -n kube-system
NAME  	NAMESPACE  	REVISION	UPDATED                                	STATUS  	CHART        	APP VERSION
cilium	kube-system	3       	2024-06-26 20:47:04.417451988 -0700 PDT	deployed	cilium-1.15.6	1.15.6    
```





